#!/usr/bin/env bash
set -euo pipefail

COMPOSE_FILE="${COMPOSE_FILE:-docker-compose.dev.yml}"
TZ_NAME="${TZ_NAME:-Asia/Shanghai}"
BLOG_URL="${BLOG_URL:-http://localhost:4000}"

usage() {
  cat <<EOF
Áî®Ê≥ï:
  ./blog dev                  ÂêØÂä®Êú¨Âú∞È¢ÑËßàÔºàdocker composeÔºåÂº∫Âà∂ÈáçÂª∫/ÈáçÂêØÔºâ
  ./blog open                 ÊâìÂºÄÊú¨Âú∞È¢ÑËßàÔºö$BLOG_URL
  ./blog down                 ÂÅúÊ≠¢Êú¨Âú∞È¢ÑËßà
  ./blog logs                 Êü•ÁúãÊó•Âøó
  ./blog sh                   ËøõÂÖ•ÂÆπÂô®
  ./blog clean                Ê∏ÖÁêÜ _site / ÁºìÂ≠ò

  ./blog new "Ê†áÈ¢ò"           Êñ∞Âª∫ÊñáÁ´†Ôºö_posts/Âπ¥/Êúà/Âπ¥-Êúà-Êó•-Ê†áÈ¢ò.md
                              ÂõæÁâáÁõÆÂΩïÔºöassets/img/Âπ¥/Êúà
                              Ëá™Âä®Áî® VS Code ÊâìÂºÄ
  ./blog new --draft "Ê†áÈ¢ò"   Êñ∞Âª∫ËçâÁ®øÔºö_drafts/Âπ¥/Êúà/Âπ¥-Êúà-Êó•-Ê†áÈ¢ò.mdÔºàÂêåÊ†∑Âª∫ÂõæÁâáÁõÆÂΩïÂπ∂ÊâìÂºÄÔºâ

ÂèØÈÄâÁéØÂ¢ÉÂèòÈáè:
  TZ_NAME=Asia/Tokyo          ËÆæÁΩÆÊó∂Èó¥/Êó∂Âå∫ÔºàÈªòËÆ§ Asia/ShanghaiÔºâ
  BLOG_URL=http://127.0.0.1:4000  open Áî®ÁöÑ URLÔºàÈªòËÆ§ http://localhost:4000Ôºâ
  COMPOSE_FILE=...            ÊåáÂÆö compose Êñá‰ª∂ÔºàÈªòËÆ§ docker-compose.dev.ymlÔºâ
EOF
}

ensure_compose_file() {
  if [[ ! -f "$COMPOSE_FILE" ]]; then
    echo "‚ùå Êâæ‰∏çÂà∞ $COMPOSE_FILEÔºàËØ∑Âú®ÂçöÂÆ¢Ê∫êÁ†ÅÊ†πÁõÆÂΩïËøêË°åÔºâ"
    exit 1
  fi
}

slugify_filename() {
  # ‰øùÁïô‰∏≠ÊñáÔºåÂéªÂç±Èô©Â≠óÁ¨¶ÔºõÁ©∫ÁôΩ->-ÔºõÂêàÂπ∂-
  printf '%s' "$1" \
    | tr '\n\r\t' '   ' \
    | sed -E 's/[[:space:]]+/-/g; s/[\/\\:\*\?"<>|]+//g; s/--+/-/g; s/^-|-$//g'
}

cmd_dev() {
  ensure_compose_file
  docker compose -f "$COMPOSE_FILE" up --build --force-recreate
}

cmd_down() {
  ensure_compose_file
  docker compose -f "$COMPOSE_FILE" down
}

cmd_logs() {
  ensure_compose_file
  docker compose -f "$COMPOSE_FILE" logs -f --tail=200
}

cmd_sh() {
  ensure_compose_file
  docker compose -f "$COMPOSE_FILE" exec dev bash
}

cmd_open() {
  local url="$BLOG_URL"

  if command -v open >/dev/null 2>&1; then
    open "$url"                          # macOS
  elif command -v xdg-open >/dev/null 2>&1; then
    xdg-open "$url"                      # Linux
  elif command -v powershell.exe >/dev/null 2>&1; then
    powershell.exe Start-Process "$url"  # WSL
  else
    echo "‚ö†Ô∏è Êó†Ê≥ïËá™Âä®ÊâìÂºÄÊµèËßàÂô®ÔºåËØ∑ÊâãÂä®ËÆøÈóÆÔºö$url"
  fi
}

cmd_clean() {
  echo "üßπ Ê∏ÖÁêÜÊûÑÂª∫‰∫ßÁâ©‰∏éÁºìÂ≠ò..."
  rm -rf _site .jekyll-cache .sass-cache .jekyll-metadata .bundle vendor/bundle 2>/dev/null || true
  echo "‚úÖ Â∑≤Ê∏ÖÁêÜÔºö_site / .jekyll-cache / .sass-cache Á≠â"
}

cmd_new() {
  local is_draft=0

  if [[ "${1:-}" == "--draft" || "${1:-}" == "-d" ]]; then
    is_draft=1
    shift || true
  fi

  local title="${*:-}"
  if [[ -z "$title" ]]; then
    echo "‚ùå Áî®Ê≥ï:"
    echo "  ./blog new \"ÊñáÁ´†Ê†áÈ¢ò\""
    echo "  ./blog new --draft \"ËçâÁ®øÊ†áÈ¢ò\""
    exit 1
  fi

  local year month date_ymd date_full safe_title post_dir img_dir file
  year="$(TZ="$TZ_NAME" date +%Y)"
  month="$(TZ="$TZ_NAME" date +%m)"
  date_ymd="$(TZ="$TZ_NAME" date +%F)"
  date_full="$(TZ="$TZ_NAME" date +"%Y-%m-%d %H:%M:%S %z")"
  safe_title="$(slugify_filename "$title")"

  if [[ "$is_draft" == "1" ]]; then
    post_dir="_drafts/${year}/${month}"
  else
    post_dir="_posts/${year}/${month}"
  fi

  img_dir="assets/img/${year}/${month}"
  file="${post_dir}/${date_ymd}-${safe_title}.md"

  mkdir -p "$post_dir" "$img_dir"

  if [[ -f "$file" ]]; then
    echo "‚ùå Â∑≤Â≠òÂú®Ôºö$file"
    exit 1
  fi

  cat > "$file" <<EOF
---
title: "${title}"
date: ${date_full}
categories: []
tags: []
---

Ê≠£ÊñáÂºÄÂßã üëá

## ÂõæÁâáÁ§∫‰æã

ÊääÂõæÁâáÊîæÂà∞Ôºö\`${img_dir}/\`

Á§∫‰æãÔºö

![demo](/${img_dir}/demo.png)

EOF

  if [[ "$is_draft" == "1" ]]; then
    echo "‚úÖ Â∑≤ÂàõÂª∫ËçâÁ®øÔºö$file"
  else
    echo "‚úÖ Â∑≤ÂàõÂª∫ÊñáÁ´†Ôºö$file"
  fi
  echo "üñºÔ∏è ÂõæÁâáÁõÆÂΩïÔºö$img_dir"

  if command -v code >/dev/null 2>&1; then
    code "$file" "$img_dir"
  else
    echo "‚ö†Ô∏è Êú™Ê£ÄÊµãÂà∞ VS Code ÁöÑ code ÂëΩ‰ª§ÔºåÊú™Ëá™Âä®ÊâìÂºÄ"
    echo "   macOS: VS Code -> Cmd+Shift+P -> Install 'code' command in PATH"
  fi
}

main() {
  local cmd="${1:-}"
  shift || true

  case "$cmd" in
    dev)    cmd_dev ;;
    open)   cmd_open ;;
    down)   cmd_down ;;
    logs)   cmd_logs ;;
    sh)     cmd_sh ;;
    clean)  cmd_clean ;;
    new)    cmd_new "$@" ;;
    ""|-h|--help|help) usage ;;
    *) echo "‚ùå Êú™Áü•ÂëΩ‰ª§: $cmd"; usage; exit 1 ;;
  esac
}

main "$@"

